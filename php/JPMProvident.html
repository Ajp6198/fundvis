<!--
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * -->
 
<!--
 * Author: NG, Yik-wai Jason
 * Contact & Support: ywng@ust.hk
 * The Hong Kong University of Science and Technology
 * Data Visualization, CSE, HKUST
 * -->
 
<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>FundVis</title>
</head>

<link href="bootstrap/css/bootstrap.css" rel="stylesheet">
<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<link href="css/bootstrap-switch.css" rel="stylesheet">


<style>

body {
  padding-bottom: 40px;
  margin:10px 5px 30px 40px;
  width: 1200px;
}

.fundCategory{
	font: 14px sans-serif;
}

text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: url(#temperature-gradient);
  stroke-width: 1.5px;
}

</style>


<body> 

<h4>JPMorgan Provident Scheme &nbsp&nbsp&nbsp&nbsp
	<input type="checkbox" name="my-checkbox" checked data-size="mini" data-on-text="$" data-off-text="%" data-on-color="primary" data-off-color="success">
</h4>

<!--
 * The fork me on Github picture is designed by D3.org     Here I used it by acknowledging the source
 * If the use is inappropriate or any copyright is infringed, please inform to amend.
 * -->
<a href="https://github.com/ywng/fundvis"><img width="149" height="149" alt="Fork me on GitHub" src="image/forkme.png" style="position:absolute;top:0;right:0;border:0;"></img></a>

<div id="graph" class="graph" style="position:relative;width:100%;height:630px"></div>


<!-- FOOTER -->
<footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>&copy; 2014 <a href="http://www.linkedin.com/pub/jason-ng/5a/a85/a0a">Jason Ng </a>&middot; <a href="#">Privacy</a> &middot; <a href="#">Terms</a></p>
</footer>

</body>


<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="js/bootstrap-switch.js"></script>

<script src="js/fund.js"></script>
<script src="js/color.js"></script>
<script src="js/picker.js"></script>
<script src="config/config.js"></script>

<script>
	$(function() {

		update(funds_actual);

		$("[name='my-checkbox']").bootstrapSwitch();
		$('input[name="my-checkbox"]').on('switchChange.bootstrapSwitch', function(event, state) {
		  //console.log(this); // DOM element
		  //console.log(event); // jQuery event
		  //console.log(state); // true | false

		  if(state==true){//state true means that $ is selected , else % is selected
		  	//console.log("actual price is selected to display");
		  	focus.select(".y.axis").select(".yaxisLabel").transition()
				.text("Actual Price $");//update axis label
			update(funds_actual);

		  }else{
		  	focus.select(".y.axis").select(".yaxisLabel").transition()
				.text("Percentage Change %");//update axis label

			funds_percent=new Array();
			for(var i=0;i<funds_actual.length;i++){
				var fundObj={
					id:funds_actual[i].id,
					name:funds_actual[i].name,
					price_array:new Array(),
					vis:funds_actual[i].vis
				}
				var priceObj={
					datetime:funds_actual[i].price_array[0].datetime,
					price:"0"
				};
				funds_percent.push(fundObj);
				funds_percent[i].price_array.push(priceObj);
				for(var j=1;j<funds_actual[i].price_array.length;j++){
					console.log(funds_actual[i].price_array[j].price);
					console.log(funds_actual[i].price_array[j-1].price);
					var percentageChange=parseFloat(funds_actual[i].price_array[j].price)/parseFloat(funds_actual[i].price_array[j-1].price)-1;
					var priceObj={
						datetime:funds_actual[i].price_array[j].datetime,
						price:percentageChange.toString()
					};
					funds_percent[i].price_array.push(priceObj);
				}
			}

			//update the funds path
			update(funds_percent);

		  }


		});
		
	});

	
	_init_funds(); 
	var margin = {top: 15, right: 50, bottom: 100, left: 50},
		margin2 = {top: 500, right: 50, bottom: 50, left: 50},
		width = 1200 - margin.left - margin.right,
		height = 570 - margin.top - margin.bottom,
		height2 = 570 - margin2.top - margin2.bottom;


	//var mousePickerDate;
	//var currIndex=data2[0].priceList.length-1;
	
	var x = d3.time.scale()
		.range([0, width-150]),
		x2 = d3.time.scale()      //for the time selection bar at the bottom
		.range([0, width-150]);

	var y = d3.scale.linear()
		.range([height, 0]),
		y2 = d3.scale.linear()   //for the time selection bar at the bottom
		.range([height2, 0]);

	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom");
		xAxis2 = d3.svg.axis()
		.scale(x2).orient("bottom");

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left");

	x.domain([parseDate(minDate),parseDate(maxDate)]); 
	y.domain([find_max_min_selected_funds(funds_actual).min-1,find_max_min_selected_funds(funds_actual).max+1]);
	x2.domain(x.domain());//the domain axis for the bar at the bottom
	
	var line = d3.svg.line()
		.interpolate("linear")
		.x(function(d) { return x(parseDate(d.datetime)); })
		.y(function(d) { return y(parseFloat(d.price));   });

	var svg = d3.select("#graph").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
	
	//the main graphic component of the plot
	var focus=svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
	//x,y-axis for the plot
	focus.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);

	focus.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.append("text")
		.attr("class", "yaxisLabel")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Actual Price $");

	focus.append("text")
		.attr("class", "fundCategory")
		.attr("x", function(d) { return width-100; })
		.attr("y", 65)
		.text( "JPMorgan Funds")
		.attr("font-family", "sans-serif")
		.attr("font-size", "30px")
		.attr("fill", "black");  
	focus.append("text")
		.attr("class", "fundCategory")
		.attr("x", function(d) { return width-100; })
		.attr("y", 275)
		.text( "Fidelity Funds")
		.attr("font-family", "sans-serif")
		.attr("font-size", "30px")
		.attr("fill", "black");  
	
	var fund;
	function update(data) {

		y.domain([find_max_min_selected_funds(data).min-1,find_max_min_selected_funds(data).max+1]);
		focus.select(".y.axis").call(yAxis);


		//curving part of these funds------------------------------------------------------------------------
		fund = focus.selectAll(".fund")
				.data(data,function(d) { return d; });
		
		fund.attr("class", "update");

		fund.enter().append("path")
			.attr("class", "line")
			.attr("clip-path", "url(#clip)")//use clip path to make irrelevant part invisible
			.attr("d", function(d) { if(d.vis=="True"){return line(d.price_array);} else{ return null;} })
			.style("stroke", function(d) { return colors(d.id-1); });

	
	
		//fund select or dis-select btn
		fund.enter().append("rect")
			.attr("height",10)
			.attr("width", 25)
			.attr("x",function(d) { 
				if(d.id<=13){
					return width-100+((d.id-1)%3)*40;
				}else{
					return width-100+((d.id-14)%3)*40;
				}
				
			})
			.attr("y",function(d) { 
				if(d.id<=13){
					return 80+Math.floor((d.id-1)/3)*35;
				}else{
					return 80+(Math.floor((d.id-14)/3)+2)*35+Math.floor((13-1)/3)*35;
				}
				
			})
			.attr("stroke", function(d) {return colors(d.id-1);})
			.attr("fill",function(d) {if(d.vis=="True"){return colors(d.id-1);}else{return "white";}})
			.on("click", function(d) { 
						console.log(d.vis);
						if(d.vis=="True"){ //show the curve or not 
							d.vis="False";
						}
						else{
							d.vis="True";
						} 

						y.domain([find_max_min_selected_funds(data).min-1,find_max_min_selected_funds(data).max+1]);
						focus.select(".y.axis").call(yAxis);
						
						fund.select("path").transition()//update curve 
							.attr("d", function(d) { if(d.vis=="True"){return line(d.price_array);} else{ return null;} });
					
						fund.select("rect").transition()//update legend 
							.attr("fill",function(d) {if(d.vis=="True"){return colors(d.id-1);}else{return "white";}});
				});  
		//end of curving part of those funds-------------------------------------------------------------	


		  // EXIT
		  // Remove old elements as needed.
		 fund.exit().remove();
	}
	
			
	//mouse picker related, hover line---------------------------------------------------------------
	var pickerValue = focus.selectAll(".pickerValue")//for displaying fund unit price 
		.data(funds_actual)
		.enter().append("g")
		.attr("class", "pickerValue");
		
	var valueChange = focus.selectAll(".valueChange")//for displaying unit price percentage change
		.data(funds_actual)
		.enter().append("g")
		.attr("class", "valueChange");
		
	var	hoverLineGroup = focus.append("g") //the vertical line across the plots
				.attr("class", "hover-line");
				
	var DateLbl = focus.append("g")  //the date label at the right upper corner part
    .attr("class", "dateLabel");

	//check the mouse event over the plot area and do the processing 
	container = document.querySelector('#graph');
	$(container).mouseleave(function(event) {
		handleMouseOutGraph(event);
		//console.log("mouse leave");
	})
	$(container).mousemove(function(event) {
		handleMouseOverGraph(event);
		//console.log("mouse move on graph");
	})		
	
	//mousePickerDate=getValueForPositionXFromData(width-210);//initial pick date is the last day of the plot
	//for displaying fund unit price
	pickerValue.append("text")
		.attr("class", "valuesLabel")
		.attr("x", function(d) { return width-205; })
		.attr("y", function(d) { return d.id*35+15;})//return getFundID(d.name)*35+15; })
		.text( function (d) { 
			var dateStr="";
			//console.log(mousePickerDate);
		/*	dateStr+=mousePickerDate.getFullYear();
			if(mousePickerDate.getMonth()+1<10){
				dateStr+="0"+(mousePickerDate.getMonth()+1);
			}else{
				dateStr+=(mousePickerDate.getMonth()+1);
			}
			if(mousePickerDate.getDate()<10){
				dateStr+="0"+mousePickerDate.getDate();
			}else{
				dateStr+=mousePickerDate.getDate();
			}
			//console.log(dateStr);
			currIndex=DateMapIndex.get(dateStr);
			return d.priceList[currIndex].price; */
		})
           .attr("font-family", "sans-serif")
           .attr("font-size", "15px")
           .attr("fill", function(d) { return colors(d.name); });  
		   
	//for displaying unit price percentage change
	valueChange.append("text")
		.attr("class", "valuesLabel")
		.attr("x", function(d) { return width-170; })
		.attr("y", function(d) { return d.id*35+15;})//return getFundID(d.name)*35+15; })
		.text( function (d) { 
		/*	var percentChange=(d.priceList[currIndex].price-d.priceList[currIndex-1].price)/d.priceList[currIndex-1].price*100;
			if(percentChange<0){
				return "(-"+percentChange.toFixed(2)+"%)" 
			}else{
				return "(+"+percentChange.toFixed(2)+"%)" 
			}*/
		})
        .attr("font-family", "sans-serif")
        .attr("font-size", "15px")
        .attr("fill", function (d) {
			/*var percentChange=(d.priceList[currIndex].price-d.priceList[currIndex-1].price)/d.priceList[currIndex-1].price*100;
			if(percentChange<0){
				return "red" 
			}else{
				return "black" 
			}*/
		});  

	//end of mouse picker related, hover line-------------------------------------------------------------------
	
	

	//**************** Slider part & Brush *******************************************//
	//********************************************************************************//
	var brush = d3.svg.brush()//for slider bar at the bottom
    .x(x2)
    .on("brush", brushed);
	
	var context = svg.append("g")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");
	
	//append click path for controlling the sliding of curve, clip those part out of bounds
	svg.append("defs").append("clipPath") 
	.attr("id", "clip")
	.append("rect")
	.attr("width", width-150)
	.attr("height", height); 
  
	context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);
	  
	var contextArea = d3.svg.area()
		.interpolate("monotone")
		.x(function(d) { return x2(parseDate(d.datetime)); })
		.y0(height2)//the height is always max height, just to plot a rectangle rather than an actual path of the data
		.y1(0);
	
	//plot the rect as the bar at the bottom
	var dummyObjToIncludeMindate={
		datetime:minDate,
		price:"0"
	};
	var dummyObjToIncludeMaxdate={
		datetime:maxDate,
		price:"0"
	};
	var sampleFundPriceArray=funds_actual[0].price_array.slice();
	sampleFundPriceArray.push(dummyObjToIncludeMaxdate);
	sampleFundPriceArray.push(dummyObjToIncludeMindate);

	context.append("path")
		.attr("class", "area")
		.attr("d", contextArea(sampleFundPriceArray))
		.attr("fill", "LightYellow ");
		
	//append the brush for the selection of subsection  
	context.append("g")
		.attr("class", "x brush")
		.call(brush)
		.selectAll("rect")
		.attr("height", height2)
	    .attr("fill", "SkyBlue");  

	//for brusher of the slider bar at the bottom
	function brushed() {
		x.domain(brush.empty() ? x2.domain() : brush.extent());
		fund.select("path").transition()//update curve 
			.attr("d", function(d) { if(d.vis=="True"){return line(d.price_array);} else{ return null;} })
		focus.select(".x.axis").call(xAxis);
	}

	//********************************************************************************//
	//**************End of Slider part & Brush****************************************//


</script>
