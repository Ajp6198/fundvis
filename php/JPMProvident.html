<!--
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * -->
 
<!--
 * Author: NG, Yik-wai Jason
 * Contact & Support: ywng@ust.hk
 * The Hong Kong University of Science and Technology
 * Data Visualization, CSE, HKUST
 * -->
 
<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>FundVis</title>
</head>
<style>

body {
  margin:10px 5px 30px 40px;
  width: 900px;
}

text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: url(#temperature-gradient);
  stroke-width: 1.5px;
}

</style>

<h4>JP Morgan Provident Scheme</h4>
<body> 

<!--
 * The fork me on Github picture is designed by D3.org     Here I used it by acknowledging the source
 * If the use is inappropriate or any copyright is infringed, please inform to amend.
 * -->
<a href="https://github.com/ywng/mpf_vis"><img width="149" height="149" alt="Fork me on GitHub" src="image/forkme.png" style="position:absolute;top:0;right:0;border:0;"></img></a>

<div id="graph" class="graph" style="position:relative;width:100%;height:630px"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="js/fund.js"></script>
<script src="js/color.js"></script>
<script src="js/picker.js"></script>
<script src="js/brush.js"></script>
<script src="config/config.js"></script>

<script>

	$( document ).ready(function() {
  		
  		_init_funds(); 


	});

	
	var margin = {top: 15, right: 50, bottom: 100, left: 50},
		margin2 = {top: 500, right: 50, bottom: 50, left: 50},
		width = 900 - margin.left - margin.right,
		height = 570 - margin.top - margin.bottom,
		height2 = 570 - margin2.top - margin2.bottom;


	//var mousePickerDate;
	//var currIndex=data2[0].priceList.length-1;
	
	var x = d3.time.scale()
		.range([0, width-210]),
		x2 = d3.time.scale()
		.range([0, width-210]);

	var y = d3.scale.linear()
		.range([height, 0]),
		y2 = d3.scale.linear()
		.range([height2, 0]);

	var xAxis = d3.svg.axis()
		.scale(x)
		.orient("bottom");
		xAxis2 = d3.svg.axis()
		.scale(x2).orient("bottom");

	var yAxis = d3.svg.axis()
		.scale(y)
		.orient("left");

	var price_array_one_of_fund=funds[0].price_array;
	x.domain([price_array_one_of_fund[price_array_one_of_fund.length-1].datetime,price_array_one_of_fund[0].datetime]); 
	y.domain([0,d3.max(price_array_one_of_fund, function(d) { return parseFloat(d.price); })]);
	x2.domain(x.domain());//the domain axis for the bar at the bottom
	
	var line = d3.svg.line()
		.interpolate("linear")
		.x(function(d) { return x(parseDate(d.datetime)); })
		.y(function(d) { return y(parseFloat(d.price));   });

	var svg = d3.select("#graph").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
	
	//the main graphic component of the plot
	var focus=svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
	//x,y-axis for the plot
	focus.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);

	focus.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Price $");
	
	//curving part of those funds------------------------------------------------------------------------
	var fund = focus.selectAll(".fund")
			.data(funds)
			.enter().append("g")
			.attr("class", "fund");

	fund.append("path")
		.attr("class", "line")
		.attr("clip-path", "url(#clip)")//use clip path to make irrelevant part invisible
		.attr("d", function(d) { if(d.vis=="True"){return line(d.price_array);} else{ return null;} })
		.style("stroke", function(d) { return colors(d.name); });

	//fund name label
	fund.append("text")
		.attr("class", "fundNameLabel")
		.attr("x", function(d) { return width-175; })
		.attr("y", function(d) { return getFundID(d.name)*35; })
		.text( function (d) { return d.name; })
		.attr("font-family", "sans-serif")
		.attr("font-size", "10px")
		.attr("fill", "black");   
	
	//fund select or dis-select btn
	fund.append("rect")
		.attr("height",10)
		.attr("width", 25)
		.attr("x",width-205)
		.attr("y",function(d) {return getFundID(d.name)*35-8;})
		.attr("stroke", function(d) {return colors(d.name);})
		.attr("fill",function(d) {if(d.vis=="1"){return colors(d.name);}else{return "white";}})
		.on("click", function(d) { 
					if(d.vis=="True"){
						d.vis="False";
					}
					else{
						d.vis="True";
					} 
				
					y.domain([0,d3.max(d.price_array, function(d) { return parseFloat(d.price); })]);
					focus.select(".y.axis").call(yAxis);
					
					fund.select("path").transition()//update curve 
						.attr("d", function(d) { if(d.vis=="True"){return line(d.price_array);} else{ return null;} })
				
					fund.select("rect").transition()//update legend 
						.attr("fill",function(d) {if(d.vis=="True"){return colors(d.name);}else{return "white";}});
			});  
	//end of curving part of those funds-------------------------------------------------------------	
			
	//mouse picker related, hover line---------------------------------------------------------------
	var pickerValue = focus.selectAll(".pickerValue")//for displaying fund unit price 
		.data(funds)
		.enter().append("g")
		.attr("class", "pickerValue");
		
	var valueChange = focus.selectAll(".valueChange")//for displaying unit price percentage change
		.data(funds)
		.enter().append("g")
		.attr("class", "valueChange");
		
	var	hoverLineGroup = focus.append("g") //the vertical line across the plots
				.attr("class", "hover-line");
				
	var DateLbl = focus.append("g")  //the date label at the right upper corner part
    .attr("class", "dateLabel");

	//check the mouse event over the plot area and do the processing 
	container = document.querySelector('#graph');
	$(container).mouseleave(function(event) {
		handleMouseOutGraph(event);
		//console.log("mouse leave");
	})
	$(container).mousemove(function(event) {
		handleMouseOverGraph(event);
		//console.log("mouse move on graph");
	})		
	
	//mousePickerDate=getValueForPositionXFromData(width-210);//initial pick date is the last day of the plot
	//for displaying fund unit price
	pickerValue.append("text")
		.attr("class", "valuesLabel")
		.attr("x", function(d) { return width-205; })
		.attr("y", function(d) { return getFundID(d.name)*35+15; })
		.text( function (d) { 
			var dateStr="";
			//console.log(mousePickerDate);
		/*	dateStr+=mousePickerDate.getFullYear();
			if(mousePickerDate.getMonth()+1<10){
				dateStr+="0"+(mousePickerDate.getMonth()+1);
			}else{
				dateStr+=(mousePickerDate.getMonth()+1);
			}
			if(mousePickerDate.getDate()<10){
				dateStr+="0"+mousePickerDate.getDate();
			}else{
				dateStr+=mousePickerDate.getDate();
			}
			//console.log(dateStr);
			currIndex=DateMapIndex.get(dateStr);
			return d.priceList[currIndex].price; */
		})
           .attr("font-family", "sans-serif")
           .attr("font-size", "15px")
           .attr("fill", function(d) { return colors(d.name); });  
		   
	//for displaying unit price percentage change
	valueChange.append("text")
		.attr("class", "valuesLabel")
		.attr("x", function(d) { return width-170; })
		.attr("y", function(d) { return getFundID(d.name)*35+15; })
		.text( function (d) { 
		/*	var percentChange=(d.priceList[currIndex].price-d.priceList[currIndex-1].price)/d.priceList[currIndex-1].price*100;
			if(percentChange<0){
				return "(-"+percentChange.toFixed(2)+"%)" 
			}else{
				return "(+"+percentChange.toFixed(2)+"%)" 
			}*/
		})
        .attr("font-family", "sans-serif")
        .attr("font-size", "15px")
        .attr("fill", function (d) {
			/*var percentChange=(d.priceList[currIndex].price-d.priceList[currIndex-1].price)/d.priceList[currIndex-1].price*100;
			if(percentChange<0){
				return "red" 
			}else{
				return "black" 
			}*/
		});  

	//end of mouse picker related, hover line-------------------------------------------------------------------
	


</script>
